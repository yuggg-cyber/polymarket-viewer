<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StandX 本地凭证提取工具 v7 (内置算法版)</title>
    
    <!-- 仅保留最稳定的 ethers 库用于钱包通信 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: #161b22; padding: 30px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        h1 { color: #58a6ff; text-align: center; margin-bottom: 10px; }
        .desc { text-align: center; color: #8b949e; margin-bottom: 30px; font-size: 0.9em; }
        .step { margin-bottom: 20px; padding: 15px; background: #0d1117; border-radius: 8px; border-left: 4px solid #238636; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 10px; }
        button { background-color: #238636; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; flex: 1; transition: background 0.2s; }
        button.okx { background-color: #ffffff; color: #000000; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #213322; color: #8b949e; cursor: not-allowed; }
        .result-area { margin-top: 30px; display: none; }
        .field { margin-bottom: 20px; }
        .label { display: block; color: #8b949e; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        .value-container { position: relative; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; word-break: break-all; font-family: monospace; font-size: 14px; }
        .warning { background: rgba(210, 153, 34, 0.1); border: 1px solid #d29922; color: #d29922; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px; }
        #status { text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>StandX 凭证提取 v7</h1>
        <p class="desc">本地生成，内置 Ed25519 算法，无需外部加密库</p>

        <div class="step">
            <p>第一步：选择并连接钱包</p>
            <div class="btn-group">
                <button id="btn-mm">连接 MetaMask</button>
                <button id="btn-okx" class="okx">连接 OKX Wallet</button>
            </div>
            <div id="status"></div>
        </div>

        <div id="result-area" class="result-area">
            <div class="field">
                <span class="label">代理钱包私钥 / AGENT WALLET PRIVATE KEY</span>
                <div class="label" style="text-transform: none;">STANDX_REQUEST_PRIVATE_KEY</div>
                <div class="value-container">
                    <span id="res-privkey"></span>
                </div>
            </div>

            <div class="field">
                <span class="label">访问令牌 / ACCESS TOKEN (JWT)</span>
                <div class="label" style="text-transform: none;">STANDX_TOKEN</div>
                <div class="value-container">
                    <span id="res-token"></span>
                </div>
            </div>

            <div class="warning">
                <strong>安全提示：</strong> 这些凭证允许完全访问您的 StandX 账户交易权限。请仅在受信任的环境中使用。
            </div>
        </div>
    </div>

    <script>
        // --- 内置 Base58 编码逻辑 ---
        const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        function encodeBase58(source) {
            if (source.length === 0) return '';
            let digits = [0];
            for (let i = 0; i < source.length; i++) {
                for (let j = 0; j < digits.length; j++) digits[j] <<= 8;
                digits[0] += source[i];
                let carry = 0;
                for (let j = 0; j < digits.length; j++) {
                    digits[j] += carry;
                    carry = (digits[j] / 58) | 0;
                    digits[j] %= 58;
                }
                while (carry) {
                    digits.push(carry % 58);
                    carry = (carry / 58) | 0;
                }
            }
            for (let i = 0; source[i] === 0 && i < source.length - 1; i++) digits.push(0);
            return digits.reverse().map(d => ALPHABET[d]).join('');
        }

        // --- 使用 Web Crypto API 生成 Ed25519 密钥对 ---
        // 现代浏览器原生支持生成 Ed25519 密钥，无需外部库
        async function generateEd25519() {
            const keyPair = await window.crypto.subtle.generateKey(
                { name: "Ed25519" },
                true,
                ["sign", "verify"]
            );
            const privRaw = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
            const pubRaw = await window.crypto.subtle.exportKey("raw", keyPair.publicKey);
            
            // 提取私钥原始字节 (PKCS8 格式中最后 32 字节通常是私钥)
            const privBytes = new Uint8Array(privRaw).slice(-32);
            const pubBytes = new Uint8Array(pubRaw);
            
            const privHex = Array.from(privBytes).map(b => b.toString(16).padStart(2, '0')).join('');
            const requestId = encodeBase58(pubBytes);
            
            return { privHex, requestId };
        }

        const status = document.getElementById('status');
        const resultArea = document.getElementById('result-area');
        const API_BASE = "https://api.standx.com/v1/offchain";

        async function startExtraction(walletType) {
            try {
                if (!window.ethers) throw new Error('ethers 库加载失败，请检查网络。');

                let provider;
                if (walletType === 'mm') {
                    if (!window.ethereum) throw new Error('未检测到 MetaMask 钱包');
                    const providers = window.ethereum.providers || [window.ethereum];
                    const mmProvider = providers.find(p => p.isMetaMask) || window.ethereum;
                    provider = new ethers.BrowserProvider(mmProvider);
                } else {
                    if (!window.okxwallet) throw new Error('未检测到 OKX 钱包');
                    provider = new ethers.BrowserProvider(window.okxwallet);
                }

                status.innerText = "正在生成本地密钥...";
                status.style.color = "#58a6ff";

                // 使用浏览器原生 Web Crypto API 生成密钥
                const { privHex, requestId } = await generateEd25519();

                const signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                status.innerText = "正在请求签名数据...";

                const prepRes = await fetch(`${API_BASE}/prepare-signin?chain=bsc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, requestId })
                });
                const prepData = await prepRes.json();
                if (!prepData.success) throw new Error("准备登录失败: " + JSON.stringify(prepData));

                const signedData = prepData.signedData;
                const payload = JSON.parse(atob(signedData.split('.')[1]));
                const message = payload.message;

                status.innerText = "请在钱包中完成签名...";
                const signature = await signer.signMessage(message);

                status.innerText = "正在换取访问令牌...";
                const loginRes = await fetch(`${API_BASE}/login?chain=bsc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signature, signedData, expiresSeconds: 604800 })
                });
                const loginData = await loginRes.json();
                
                if (loginData.token) {
                    document.getElementById('res-privkey').innerText = privHex;
                    document.getElementById('res-token').innerText = loginData.token;
                    resultArea.style.display = 'block';
                    status.innerText = "✅ 提取成功！";
                    status.style.color = "#238636";
                } else {
                    throw new Error("登录失败，未获取到 Token");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "❌ 错误: " + err.message;
                status.style.color = "#f85149";
            }
        }

        document.getElementById('btn-mm').onclick = () => startExtraction('mm');
        document.getElementById('btn-okx').onclick = () => startExtraction('okx');
    </script>
</body>
</html>
