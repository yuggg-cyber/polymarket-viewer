<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Crypto Now (2025)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #0b1221; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .scanning-line {
            height: 2px;
            width: 100%;
            background: linear-gradient(to right, transparent, #f97316, transparent);
            animation: scan 1.5s linear infinite;
        }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>
</head>
<body class="text-slate-300 min-h-screen">

    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- å¤´éƒ¨ -->
        <header class="mb-8 border-b border-slate-800 pb-6">
            <h1 class="text-3xl font-bold text-white flex items-center gap-3 mb-2">
                <span class="text-orange-500">âš¡</span> æœ€æ–°åŠ å¯†è´§å¸é¢„æµ‹
            </h1>
            <p class="text-slate-500 text-sm">
                å½“å‰æ—¶é—´: <span class="text-white font-mono">{{ nowStr }}</span> | 
                <span class="text-orange-400">åªæ˜¾ç¤ºåœ¨æ­¤ä¹‹åçš„ç›˜å£</span>
            </p>
            
            <!-- çŠ¶æ€é¢æ¿ -->
            <div class="mt-4 bg-slate-900 rounded-lg p-3 border border-slate-800 flex flex-wrap gap-4 text-xs font-mono">
                <div>
                    <span class="text-slate-500">å·²æ‰«æåŸå§‹æ•°æ®:</span>
                    <span class="text-white ml-1">{{ scannedCount }} æ¡</span>
                </div>
                <div>
                    <span class="text-slate-500">è¿‡æ»¤æ‰çš„è¿‡æœŸ/æ— å…³æ•°æ®:</span>
                    <span class="text-red-400 ml-1">{{ scannedCount - validMarkets.length }} æ¡</span>
                </div>
                <div>
                    <span class="text-slate-500">æœ‰æ•ˆæ–°æ•°æ®:</span>
                    <span class="text-green-400 ml-1 font-bold text-sm">{{ validMarkets.length }} æ¡</span>
                </div>
            </div>
            
            <!-- æ‰«æåŠ¨ç”» -->
            <div v-if="loading" class="mt-4 w-full bg-slate-900 h-1 overflow-hidden relative rounded-full">
                <div class="scanning-line"></div>
            </div>
            <div v-if="loading" class="text-center text-orange-400 text-xs mt-2 animate-pulse">
                æ­£åœ¨æš´åŠ›æ¸…æ´—å†å²æ•°æ®ï¼Œå¯»æ‰¾æœ€æ–°ç›˜å£... (å·²è·³è¿‡ {{ scannedCount }} æ¡)
            </div>
        </header>

        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="bg-red-900/30 border border-red-500/50 p-4 rounded text-center text-red-200 mb-6">
            {{ error }}
            <button @click="initSearch" class="underline ml-2">é‡è¯•</button>
        </div>

        <!-- åˆ—è¡¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
            <div v-for="market in validMarkets" :key="market.condition_id" 
                 class="bg-[#131b2e] border border-slate-800 rounded-xl p-5 hover:border-orange-500/50 transition-all flex flex-col relative group">
                
                <!-- æˆªæ­¢æ—¥æœŸ (é«˜äº®æ˜¾ç¤º) -->
                <div class="absolute top-0 right-0 bg-slate-800 text-[10px] px-2 py-1 rounded-bl-lg border-b border-l border-slate-700 text-green-400 font-mono">
                    æˆªæ­¢: {{ formatDate(market.end_date_iso) }}
                </div>

                <!-- æ ‡ç­¾ -->
                <div class="mb-3 mt-1">
                    <span class="bg-orange-500/10 text-orange-400 border border-orange-500/20 px-2 py-0.5 rounded text-[10px] font-bold">
                        {{ detectCoin(market.question) }}
                    </span>
                </div>

                <!-- æ ‡é¢˜ -->
                <h3 class="font-medium text-slate-100 text-[15px] leading-relaxed mb-4 line-clamp-3 group-hover:text-orange-300 transition-colors h-[4.5rem]">
                    <a :href="'https://polymarket.com/event/' + market.market_slug" target="_blank">
                        {{ market.question }}
                    </a>
                </h3>

                <!-- ä»·æ ¼ -->
                <div class="mt-auto space-y-2">
                    <div v-for="(token, idx) in (market.tokens || []).slice(0, 2)" :key="idx" 
                         class="flex justify-between items-center text-xs bg-slate-900/50 p-2 rounded">
                        <span class="text-slate-400 truncate max-w-[60%]">{{ token.outcome }}</span>
                        <span class="font-mono font-bold" :class="token.price > 0.5 ? 'text-green-400' : 'text-blue-400'">
                            {{ (token.price * 100).toFixed(0) }}Â¢
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨åŠ è½½ -->
        <div class="py-12 text-center" v-if="validMarkets.length > 0">
            <button @click="loadMore" :disabled="loading"
                    class="px-8 py-2 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-full text-sm transition-colors disabled:opacity-50">
                {{ loading ? 'æ­£åœ¨æœå¯»æ›´å¤š...' : 'åŠ è½½æ›´å¤š (Load More)' }}
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ğŸ‘‡ ä½ çš„ Worker åœ°å€ (ä¿æŒä¸å˜)
                const WORKER_URL = 'https://gentle-wave-3a18.9241858.workers.dev'; 

                const validMarkets = ref([]);   // æœ€ç»ˆå±•ç¤ºçš„åˆ—è¡¨
                const nextCursor = ref(null);   // ç¿»é¡µæ¸¸æ ‡
                const loading = ref(false);
                const error = ref(null);
                const scannedCount = ref(0);    // ç»Ÿè®¡ä¸€å…±æ‰«æäº†å¤šå°‘åƒåœ¾æ•°æ®
                
                const now = new Date(); // å½“å‰æ—¶é—´
                const nowStr = now.toLocaleDateString();

                // ğŸ” åŠ å¯†è´§å¸å…³é”®è¯
                const CRYPTO_KEYWORDS = [
                    'Bitcoin', 'BTC', 'Ethereum', 'ETH', 'Solana', 'SOL', 
                    'Crypto', 'Token', 'Airdrop', 'NFT', 'Price', 'USDC', 'USDT', 
                    'ETF', 'Binance', 'Coinbase', 'Trump', 'Polymarket' // Trumpå¸¸å…³è”Cryptoç›˜å£
                ];

                // ğŸ› ï¸ æ ¸å¿ƒï¼šåˆ¤æ–­ä¸€ä¸ªç›˜å£æ˜¯å¦â€œæ–°é²œâ€ä¸”â€œç›¸å…³â€
                const isValidMarket = (m) => {
                    // 1. å¿…é¡»æœ‰æˆªæ­¢æ—¥æœŸ
                    if (!m.end_date_iso) return false;
                    
                    // 2. æˆªæ­¢æ—¥æœŸå¿…é¡»åœ¨ä»Šå¤©ä¹‹å (å…³é”®ä¿®æ”¹ï¼)
                    const endDate = new Date(m.end_date_iso);
                    if (endDate < now) return false;

                    // 3. å¿…é¡»åŒ…å«å…³é”®è¯
                    const q = m.question.toLowerCase();
                    const isCrypto = CRYPTO_KEYWORDS.some(k => q.includes(k.toLowerCase()));
                    if (!isCrypto) return false;

                    // 4. å¿…é¡»æœ‰ä»·æ ¼
                    if (!m.tokens || m.tokens.length < 2) return false;

                    return true;
                };

                // ğŸ”„ é€’å½’æŠ“å–å‡½æ•°ï¼šå¦‚æœä¸æ»¡ä¸€å±æ•°æ®ï¼Œå°±ä¸€ç›´æŠ“ä¸‹ä¸€é¡µ
                const fetchAndFilter = async (cursor = null, accumulate = false) => {
                    try {
                        let url = `${WORKER_URL}?limit=100`; // æ¯æ¬¡æŠ“100æ¡
                        if (cursor) url += `&cursor=${cursor}`;
                        
                        // åŠ æ—¶é—´æˆ³é˜²ç¼“å­˜
                        url += `&_t=${new Date().getTime()}`;

                        const response = await axios.get(url);
                        let result = response.data;
                        if (typeof result === 'string') try { result = JSON.parse(result); } catch(e){}

                        const rawList = result.data || [];
                        const newCursor = result.next_cursor;
                        
                        scannedCount.value += rawList.length;

                        // ğŸ” è¿‡æ»¤å‡ºæœ‰æ•ˆæ•°æ®
                        const freshData = rawList.filter(isValidMarket);
                        
                        // æ›´æ–° UI
                        if (accumulate) {
                            validMarkets.value = [...validMarkets.value, ...freshData];
                        } else {
                            // åˆå§‹åŠ è½½æ—¶ï¼Œæ˜¯è¿½åŠ æ¨¡å¼
                            validMarkets.value = [...validMarkets.value, ...freshData];
                        }
                        
                        nextCursor.value = newCursor;

                        // ğŸ§  æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœå½“å‰æ‰¾åˆ°çš„æœ‰æ•ˆæ•°æ®å¤ªå°‘ (å°äº12æ¡)ï¼Œä¸”è¿˜æœ‰ä¸‹ä¸€é¡µï¼Œè‡ªåŠ¨ç»§ç»­æŠ“ï¼
                        if (validMarkets.value.length < 12 && newCursor) {
                            console.log(`æœ‰æ•ˆæ•°æ®ä¸è¶³ (${validMarkets.value.length}æ¡)ï¼Œç»§ç»­æ‰«æä¸‹ä¸€é¡µ...`);
                            await fetchAndFilter(newCursor, true);
                        } else {
                            loading.value = false; // å‡‘å¤Ÿäº†ï¼Œåœæ­¢åŠ è½½
                        }

                    } catch (err) {
                        console.error(err);
                        error.value = "æ•°æ®æµä¸­æ–­: " + err.message;
                        loading.value = false;
                    }
                };

                const initSearch = () => {
                    loading.value = true;
                    error.value = null;
                    validMarkets.value = [];
                    scannedCount.value = 0;
                    fetchAndFilter(null, false);
                };

                const loadMore = () => {
                    loading.value = true;
                    fetchAndFilter(nextCursor.value, true);
                };

                const detectCoin = (q) => {
                    q = q.toLowerCase();
                    if(q.includes('bitcoin') || q.includes('btc')) return 'BTC';
                    if(q.includes('eth')) return 'ETH';
                    if(q.includes('sol')) return 'SOL';
                    return 'CRYPTO';
                }

                const formatDate = (iso) => new Date(iso).toLocaleDateString();

                onMounted(() => {
                    initSearch();
                });

                return {
                    validMarkets, scannedCount, loading, error, 
                    loadMore, initSearch, detectCoin, formatDate, nowStr
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
