<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket æ·±åº¦ç›¯ç›˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { background-color: #0f172a; font-family: -apple-system, monospace; color: #cbd5e1; }
        /* ä¹°ç›˜ç»¿è‰²èƒŒæ™¯æ¡ */
        .bid-bg { background: rgba(16, 185, 129, 0.15); }
        /* å–ç›˜çº¢è‰²èƒŒæ™¯æ¡ */
        .ask-bg { background: rgba(244, 63, 94, 0.15); }
        .nums { font-variant-numeric: tabular-nums; }
        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="container mx-auto px-4 py-6 max-w-6xl">
        
        <!-- é¡¶éƒ¨ -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-800">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-blue-500">ğŸ“Š</span> Polymarket æ·±åº¦ç›¯ç›˜
            </h1>
            <div class="text-xs text-slate-500">
                ç‚¹å‡»ä»·æ ¼æŒ‰é’®æŸ¥çœ‹å®æ—¶æŒ‚å• (Order Book)
            </div>
        </header>

        <!-- å¸‚åœºåˆ—è¡¨ (å·¦ä¾§é€‰æ‹©) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="market in markets" :key="market.condition_id" 
                 class="bg-slate-900 border border-slate-800 rounded-lg p-4 hover:border-blue-500/30 transition-colors">
                
                <h3 class="text-sm text-slate-200 font-medium mb-4 line-clamp-2 h-10 leading-snug">
                    <a :href="'https://polymarket.com/event/' + market.market_slug" target="_blank" class="hover:underline">
                        {{ market.question }}
                    </a>
                </h3>

                <!-- æ“ä½œæŒ‰é’®åŒº -->
                <div class="space-y-2">
                    <div v-for="token in (market.tokens || []).slice(0, 2)" :key="token.token_id" 
                         class="flex justify-between items-center bg-slate-950 p-2 rounded border border-slate-800">
                        <span class="text-xs font-bold text-slate-400 w-12">{{ token.outcome }}</span>
                        
                        <!-- ç‚¹å‡»è¿™ä¸ªæŒ‰é’®è§¦å‘ç›¯ç›˜ -->
                        <button @click="openBook(market, token)" 
                                class="flex-1 ml-3 bg-slate-800 hover:bg-slate-700 text-white py-1 px-3 rounded text-xs font-mono flex justify-between group transition-all active:scale-95 border border-slate-700 hover:border-blue-500">
                            <span>æŸ¥çœ‹æ·±åº¦</span>
                            <span :class="token.price > 0.5 ? 'text-green-400' : 'text-blue-400'" class="font-bold">
                                {{ (token.price * 100).toFixed(1) }}Â¢
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸ“¡ å®æ—¶æŒ‚å•å¼¹çª— (æ ¸å¿ƒåŠŸèƒ½) -->
        <transition name="modal">
            <div v-if="selectedToken" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" @click.self="closeBook">
                <div class="bg-[#1e293b] w-full max-w-2xl rounded-xl shadow-2xl border border-slate-700 overflow-hidden flex flex-col max-h-[90vh]">
                    
                    <!-- å¼¹çª—å¤´éƒ¨ -->
                    <div class="p-4 border-b border-slate-700 bg-slate-900 flex justify-between items-start">
                        <div>
                            <div class="text-xs text-slate-500 mb-1">æ­£åœ¨ç›¯ç›˜:</div>
                            <h3 class="font-bold text-white text-sm md:text-base pr-4">{{ selectedMarket.question }}</h3>
                            <div class="mt-2 inline-flex items-center gap-2 px-2 py-1 bg-slate-800 rounded text-xs font-mono">
                                <span class="text-slate-400">é€‰é¡¹:</span>
                                <span class="font-bold text-white">{{ selectedToken.outcome }}</span>
                                <span class="text-slate-600">|</span>
                                <span class="text-green-400 animate-pulse">â— å®æ—¶åˆ·æ–°ä¸­ (2s)</span>
                            </div>
                        </div>
                        <button @click="closeBook" class="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
                    </div>

                    <!-- è®¢å•ç°¿ä¸»ä½“ (ä¹°å–ç›˜) -->
                    <div class="flex-1 overflow-auto p-2 bg-[#0f172a] font-mono text-xs">
                        <div class="grid grid-cols-2 gap-2 h-full">
                            
                            <!-- ä¹°ç›˜ (Bids) -->
                            <div class="flex flex-col">
                                <div class="text-center text-green-500 font-bold border-b border-slate-800 pb-2 mb-2">ä¹°å• (Bids)</div>
                                <div class="flex justify-between text-slate-500 px-2 mb-1 text-[10px]">
                                    <span>æ•°é‡ (Size)</span>
                                    <span>ä»·æ ¼ (Price)</span>
                                </div>
                                <div class="flex-1 overflow-auto space-y-0.5">
                                    <div v-for="(bid, i) in orderBook.bids" :key="'b'+i" 
                                         class="flex justify-between px-2 py-1 rounded relative overflow-hidden text-slate-200">
                                        <!-- æ·±åº¦æ¡ -->
                                        <div class="absolute right-0 top-0 bottom-0 bg-green-500/20" :style="{width: getDepthWidth(bid.size) + '%'}"></div>
                                        <span class="relative z-10">{{ formatSize(bid.size) }}</span>
                                        <span class="relative z-10 text-green-400 font-bold">{{ bid.price }}</span>
                                    </div>
                                    <div v-if="orderBook.bids.length === 0" class="text-center text-slate-600 py-4">æš‚æ— ä¹°å•</div>
                                </div>
                            </div>

                            <!-- å–ç›˜ (Asks) -->
                            <div class="flex flex-col">
                                <div class="text-center text-red-500 font-bold border-b border-slate-800 pb-2 mb-2">å–å• (Asks)</div>
                                <div class="flex justify-between text-slate-500 px-2 mb-1 text-[10px]">
                                    <span>ä»·æ ¼ (Price)</span>
                                    <span>æ•°é‡ (Size)</span>
                                </div>
                                <div class="flex-1 overflow-auto space-y-0.5">
                                    <div v-for="(ask, i) in orderBook.asks" :key="'a'+i" 
                                         class="flex justify-between px-2 py-1 rounded relative overflow-hidden text-slate-200">
                                        <!-- æ·±åº¦æ¡ -->
                                        <div class="absolute left-0 top-0 bottom-0 bg-red-500/20" :style="{width: getDepthWidth(ask.size) + '%'}"></div>
                                        <span class="relative z-10 text-red-400 font-bold">{{ ask.price }}</span>
                                        <span class="relative z-10">{{ formatSize(ask.size) }}</span>
                                    </div>
                                    <div v-if="orderBook.asks.length === 0" class="text-center text-slate-600 py-4">æš‚æ— å–å•</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading && markets.length===0" class="text-center text-slate-500 mt-20">æ­£åœ¨è¿æ¥äº¤æ˜“æ‰€...</div>

    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                // ğŸ‘‡ ä½ çš„ Cloudflare Worker åœ°å€
                const WORKER_URL = 'https://gentle-wave-3a18.9241858.workers.dev'; 

                const markets = ref([]);
                const loading = ref(false);
                
                // ç›¯ç›˜ç›¸å…³çŠ¶æ€
                const selectedMarket = ref(null);
                const selectedToken = ref(null);
                const orderBook = ref({ bids: [], asks: [] });
                const timer = ref(null);

                // 1. è·å–å¸‚åœºåˆ—è¡¨ (ç”¨äºé€‰æ‹©)
                const fetchMarkets = async () => {
                    loading.value = true;
                    try {
                        const res = await axios.get(`${WORKER_URL}?mode=list`); // ä½¿ç”¨ mode=list
                        let data = res.data;
                        if(typeof data === 'string') try { data = JSON.parse(data); } catch(e){}
                        markets.value = (data.data || []).filter(m => m.tokens && m.tokens.length >= 2);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                // 2. æ‰“å¼€ç›¯ç›˜çª—å£
                const openBook = (market, token) => {
                    selectedMarket.value = market;
                    selectedToken.value = token;
                    orderBook.value = { bids: [], asks: [] }; // æ¸…ç©ºæ—§æ•°æ®
                    
                    // ç«‹å³æŠ“å–ä¸€æ¬¡ï¼Œç„¶åå¼€å¯è½®è¯¢
                    fetchBook();
                    timer.value = setInterval(fetchBook, 2000); // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡
                };

                // 3. å…³é—­çª—å£
                const closeBook = () => {
                    selectedToken.value = null;
                    selectedMarket.value = null;
                    if (timer.value) {
                        clearInterval(timer.value);
                        timer.value = null;
                    }
                };

                // 4. è·å–è®¢å•ç°¿æ•°æ® (æ ¸å¿ƒ)
                const fetchBook = async () => {
                    if (!selectedToken.value) return;
                    try {
                        // ä½¿ç”¨ mode=book å¹¶ä¼ å…¥ token_id
                        const url = `${WORKER_URL}?mode=book&token_id=${selectedToken.value.token_id}`;
                        const res = await axios.get(url);
                        let data = res.data;
                        
                        // CLOB API è¿”å›æ ¼å¼: { bids: [{price, size}, ...], asks: [...] }
                        // æ•°æ®å¤„ç†ï¼šåªå–å‰20æ¡£ï¼Œå¹¶è½¬æ¢æ•°å€¼
                        orderBook.value = {
                            bids: (data.bids || []).slice(0, 20),
                            asks: (data.asks || []).slice(0, 20)
                        };

                    } catch (e) {
                        console.error("ç›¯ç›˜å¤±è´¥:", e);
                    }
                };

                // è¾…åŠ©ï¼šè®¡ç®—æ·±åº¦æ¡å®½åº¦ (è§†è§‰æ•ˆæœ)
                const getDepthWidth = (size) => {
                    const s = parseFloat(size);
                    // å‡è®¾æœ€å¤§å•ç¬”æ˜¯ 5000Uï¼ŒæŒ‰æ¯”ä¾‹æ˜¾ç¤ºå®½åº¦
                    return Math.min((s / 5000) * 100, 100); 
                };

                const formatSize = (s) => parseFloat(s).toFixed(2);

                onMounted(() => {
                    fetchMarkets();
                });

                onUnmounted(() => {
                    if (timer.value) clearInterval(timer.value);
                });

                return {
                    markets, loading,
                    selectedMarket, selectedToken, orderBook,
                    openBook, closeBook,
                    getDepthWidth, formatSize
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
