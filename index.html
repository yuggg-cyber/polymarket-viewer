<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Pro</title>
    <!-- å¼•å…¥ Tailwind CSS (æ ·å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 (é€»è¾‘) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Axios (ç½‘ç»œè¯·æ±‚) -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">

    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="mb-10 flex flex-col md:flex-row justify-between items-end border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">
                    Polymarket Pro
                </h1>
                <p class="text-slate-400 text-sm md:text-base">
                    å®æ—¶çƒ­é—¨é¢„æµ‹å¸‚åœº | ä½ çš„ç§äººä¸­è½¬é€šé“
                </p>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="mt-4 md:mt-0">
                <div v-if="loading" class="flex items-center text-blue-400 animate-pulse">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    æ­£åœ¨åŒæ­¥æ•°æ®...
                </div>
                <div v-else class="text-emerald-500 font-medium flex items-center text-sm bg-emerald-500/10 px-3 py-1 rounded-full border border-emerald-500/20">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>
                    æ•°æ®è¿æ¥æ­£å¸¸
                </div>
            </div>
        </header>

        <!-- é”™è¯¯æç¤ºé¢æ¿ -->
        <div v-if="error" class="bg-red-500/10 border border-red-500/50 text-red-200 p-6 rounded-xl mb-8 text-center backdrop-blur-sm shadow-lg shadow-red-900/20">
            <h3 class="font-bold text-lg mb-2">è¿æ¥å‡ºé”™</h3>
            <p>{{ error }}</p>
            <button @click="retry" class="mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-colors">é‡è¯•</button>
        </div>

        <!-- æ ¸å¿ƒå†…å®¹ï¼šå¸‚åœºåˆ—è¡¨ç½‘æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div v-for="market in markets" :key="market.id" 
                 class="group bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden hover:border-blue-500/50 hover:shadow-2xl hover:shadow-blue-500/10 transition-all duration-300 flex flex-col">
                
                <!-- å¡ç‰‡å¤´éƒ¨ï¼šå›¾ç‰‡ä¸æ ‡é¢˜ -->
                <div class="p-5 flex-grow">
                    <div class="flex items-start gap-4">
                        <!-- å›¾ç‰‡ï¼šå¸¦æœ‰åŠ è½½å¤±è´¥å›é€€æœºåˆ¶ -->
                        <img :src="market.image || 'https://polymarket.com/images/fallback.png'" 
                             @error="e => e.target.src='https://polymarket.com/images/fallback.png'"
                             class="w-12 h-12 rounded-full object-cover bg-slate-800 ring-2 ring-slate-800 shrink-0 group-hover:scale-110 transition-transform duration-300">
                        <div>
                            <h3 class="font-bold text-slate-200 leading-snug line-clamp-3 group-hover:text-blue-300 transition-colors" :title="market.question">
                                {{ market.question }}
                            </h3>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡ä¸­éƒ¨ï¼šé€‰é¡¹ä¸ä»·æ ¼ -->
                <div class="px-5 pb-4 space-y-2">
                    <div v-for="(outcome, idx) in parseOutcomes(market.outcomeNames)" :key="idx" 
                         class="flex justify-between items-center text-sm p-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 transition-colors">
                        <span class="text-slate-400 truncate max-w-[60%]">{{ outcome }}</span>
                        <!-- ä»·æ ¼é¢œè‰²é€»è¾‘ï¼š>60%ç»¿è‰²ï¼Œ<40%çº¢è‰²ï¼Œä¸­é—´è“è‰² -->
                        <span class="font-mono font-bold" :class="getPriceColor(parsePrices(market.outcomePrices)[idx])">
                            {{ (parseFloat(parsePrices(market.outcomePrices)[idx]) * 100).toFixed(0) }}%
                        </span>
                    </div>
                </div>

                <!-- å¡ç‰‡åº•éƒ¨ï¼šäº¤æ˜“é‡ä¸é“¾æ¥ -->
                <div class="px-5 py-3 bg-slate-950/50 border-t border-slate-800 flex justify-between items-center text-xs text-slate-500">
                    <div class="flex items-center gap-1">
                        ğŸ”¥ <span class="text-slate-400 font-mono">${{ formatMoney(market.volume24h) }}</span>
                    </div>
                    <a :href="'https://polymarket.com/event/' + market.slug" target="_blank"
                       class="text-blue-400 hover:text-blue-300 font-medium hover:underline flex items-center gap-1">
                        å»äº¤æ˜“ <span class="text-lg leading-none">&rsaquo;</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div class="text-center mt-12 mb-16" v-if="markets.length > 0">
            <button @click="loadMore" :disabled="loading"
                    class="px-8 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-full font-medium transition-all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:hover:scale-100 border border-slate-700 shadow-lg">
                {{ loading ? 'æ­£åœ¨åŠ è½½æ›´å¤š...' : 'åŠ è½½æ›´å¤šçƒ­é—¨é¢„æµ‹' }}
            </button>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div v-if="!loading && markets.length === 0 && !error" class="text-center text-slate-500 mt-20">
            æš‚æ— æ•°æ®ï¼Œè¯·ç¨ååˆ·æ–°é‡è¯•ã€‚
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // âœ… è¿™é‡Œå·²ç»é…ç½®å¥½äº†ä½ çš„ä¸“å± Cloudflare Worker åœ°å€
                const WORKER_URL = 'https://gentle-wave-3a18.9241858.workers.dev'; 

                const markets = ref([]);
                const loading = ref(false);
                const error = ref(null);
                const offset = ref(0);
                const limit = 12; // æ¯æ¬¡åŠ è½½12ä¸ª

                // GraphQL æŸ¥è¯¢è¯­å¥ï¼šè·å–å›¾ç‰‡ã€ä»·æ ¼ã€äº¤æ˜“é‡ï¼Œå¹¶æŒ‰çƒ­åº¦æ’åº
                const QUERY = `
                    query GetMarkets($limit: Int, $offset: Int) {
                        markets(
                            limit: $limit, 
                            offset: $offset, 
                            where: { closed: false, active: true, volume24h_gt: 1000 }, 
                            order: volume24h_DESC
                        ) {
                            id
                            question
                            slug
                            outcomePrices
                            outcomeNames
                            volume24h
                            image
                        }
                    }
                `;

                const fetchMarkets = async (isLoadMore = false) => {
                    if (loading.value) return;
                    loading.value = true;
                    error.value = null;

                    try {
                        // å‘é€è¯·æ±‚åˆ°ä½ çš„ Cloudflare Worker
                        const response = await axios.post(WORKER_URL, {
                            query: QUERY,
                            variables: {
                                limit: limit,
                                offset: offset.value
                            }
                        });

                        // é”™è¯¯å¤„ç†
                        if (response.data.error) throw new Error(response.data.error);
                        if (response.data.errors) throw new Error(response.data.errors[0].message);
                        if (!response.data.data || !response.data.data.markets) throw new Error("è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸");

                        const newMarkets = response.data.data.markets;
                        
                        // åˆå¹¶æ•°æ®
                        if (isLoadMore) {
                            markets.value = [...markets.value, ...newMarkets];
                        } else {
                            markets.value = newMarkets;
                        }
                        
                        offset.value += limit;

                    } catch (err) {
                        console.error(err);
                        error.value = `æ•°æ®åŠ è½½å¤±è´¥: ${err.message}ã€‚è¯·ç¡®ä¿ Cloudflare Worker å·²éƒ¨ç½²ä¸”å…è®¸è·¨åŸŸã€‚`;
                    } finally {
                        loading.value = false;
                    }
                };

                // å·¥å…·å‡½æ•°ï¼šè§£æ JSON å­—ç¬¦ä¸² (Outcome Names & Prices)
                const parseOutcomes = (str) => {
                    try { return JSON.parse(str).slice(0, 2); } catch(e) { return ['Yes', 'No']; }
                };
                const parsePrices = (str) => {
                    try { return JSON.parse(str).slice(0, 2); } catch(e) { return ['0', '0']; }
                };

                // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–é‡‘é¢ (1,234)
                const formatMoney = (val) => {
                    if (!val) return '0';
                    return parseInt(val).toLocaleString('en-US');
                };

                // å·¥å…·å‡½æ•°ï¼šæ ¹æ®æ¦‚ç‡è¿”å›é¢œè‰²
                const getPriceColor = (p) => {
                    const val = parseFloat(p);
                    if (val >= 0.6) return 'text-emerald-400'; // å¤§äº60% ç»¿è‰²
                    if (val <= 0.4) return 'text-rose-400';    // å°äº40% çº¢è‰²
                    return 'text-blue-400';                    // ä¸­é—´ è“è‰²
                };

                const loadMore = () => fetchMarkets(true);
                const retry = () => fetchMarkets(false);

                onMounted(() => {
                    fetchMarkets();
                });

                return {
                    markets,
                    loading,
                    error,
                    loadMore,
                    retry,
                    parseOutcomes,
                    parsePrices,
                    formatMoney,
                    getPriceColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
