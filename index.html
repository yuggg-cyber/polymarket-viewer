<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StandX å®‰å…¨æˆæƒç”Ÿæˆå™¨ (çº¯å‰ç«¯ç‰ˆ)</title>
    <!-- å¼•å…¥ Ethers.js (é’±åŒ…è¿æ¥) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ TweetNaCl (Ed25519 åŠ å¯†ç®—æ³•) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
    
    <style>
        :root { --bg: #0f111a; --card: #1e2330; --primary: #3b82f6; --text: #e2e8f0; --muted: #94a3b8; --border: #2d3748; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .container { background-color: var(--card); width: 100%; max-width: 600px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2 { text-align: center; margin-top: 0; color: #fff; }
        .status-box { background: #13161c; border: 1px solid #334155; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; color: var(--muted); margin-bottom: 20px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .btn { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn:hover { background-color: #2563eb; }
        .btn:disabled { background-color: #334155; cursor: not-allowed; opacity: 0.7; }
        .result-group { margin-top: 25px; display: none; border-top: 1px solid var(--border); padding-top: 20px; }
        .field-label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .field-box { background: #0f111a; border: 1px solid var(--border); color: #a5b4fc; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 14px; word-break: break-all; position: relative; margin-bottom: 15px; }
        .copy-tag { font-size: 11px; color: var(--primary); cursor: pointer; text-decoration: underline; }
        .security-note { font-size: 12px; color: #fbbf24; background: rgba(251, 191, 36, 0.1); padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px solid rgba(251, 191, 36, 0.2); }
    </style>
</head>
<body>

<div class="container">
    <h2>StandX API å‡­è¯ç”Ÿæˆå™¨</h2>
    
    <div class="security-note">
        <strong>ğŸ”’ å®‰å…¨æœºåˆ¶è¯´æ˜ï¼š</strong><br>
        1. æ‚¨çš„äº¤æ˜“ç§é’¥ (Ed25519) å®Œå…¨åœ¨æµè§ˆå™¨æœ¬åœ°ç”Ÿæˆã€‚<br>
        2. åªæœ‰<b>å…¬é’¥</b>ä¼šè¢«å‘é€ç»™æœåŠ¡å™¨è¿›è¡Œæ³¨å†Œã€‚<br>
        3. <b>ç§é’¥ç»ä¸ç¦»çº¿</b>ï¼Œä¹Ÿä¸é€šè¿‡ç½‘ç»œä¼ è¾“ã€‚
    </div>

    <div id="status" class="status-box">ç­‰å¾…æ“ä½œ...</div>

    <button id="btn-connect" class="btn" onclick="runProcess()">è¿æ¥é’±åŒ…å¹¶ç”Ÿæˆå‡­è¯</button>

    <div id="results" class="result-group">
        <div class="field-label">
            <span>è¯·æ±‚ç§é’¥ (STANDX_REQUEST_PRIVATE_KEY)</span>
            <span class="copy-tag" onclick="copyText('out-priv')">å¤åˆ¶</span>
        </div>
        <div id="out-priv" class="field-box" style="color: #f472b6;"></div>

        <div class="field-label">
            <span>è®¿é—®ä»¤ç‰Œ (STANDX_TOKEN)</span>
            <span class="copy-tag" onclick="copyText('out-token')">å¤åˆ¶</span>
        </div>
        <div id="out-token" class="field-box"></div>

        <div class="field-label">
            <span>è¿‡æœŸæ—¶é—´ (STANDX_TOKEN_EXPIRY)</span>
        </div>
        <div id="out-expiry" class="field-box"></div>

        <button class="btn" style="background-color: #10b981; margin-top: 10px;" onclick="copyAll()">å¤åˆ¶å…¨éƒ¨é…ç½® (ç”¨äº .env)</button>
    </div>
</div>

<script>
    // é…ç½® StandX çš„ API åœ°å€ (æ ¹æ®ä½ ä¹‹å‰æä¾›çš„ä»£ç )
    const API_URL = "https://api.standx.com/v1/offchain";

    // å·¥å…·å‡½æ•°ï¼šBase58 ç¼–ç  (ç”¨äºç”Ÿæˆ requestId)
    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function toBase58(buffer) {
        const bytes = new Uint8Array(buffer);
        let digits = [0];
        for (let i = 0; i < bytes.length; i++) {
            for (let j = 0; j < digits.length; j++) digits[j] <<= 8;
            digits[0] += bytes[i];
            let carry = 0;
            for (let j = 0; j < digits.length; j++) {
                digits[j] += carry;
                carry = (digits[j] / 58) | 0;
                digits[j] %= 58;
            }
            while (carry) {
                digits.push(carry % 58);
                carry = (carry / 58) | 0;
            }
        }
        for (let i = 0; bytes[i] === 0 && i < bytes.length - 1; i++) digits.push(0);
        return digits.reverse().map(d => ALPHABET[d]).join('');
    }

    // å·¥å…·å‡½æ•°ï¼šHex è½¬æ¢
    function toHex(uint8arr) {
        return Array.from(uint8arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function setStatus(msg, type = 'normal') {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.style.color = type === 'error' ? '#f87171' : (type === 'success' ? '#4ade80' : '#94a3b8');
    }

    async function runProcess() {
        const btn = document.getElementById('btn-connect');
        try {
            btn.disabled = true;
            
            // 1. æ£€æŸ¥é’±åŒ…ç¯å¢ƒ
            if (!window.ethereum) throw new Error("æœªæ£€æµ‹åˆ° MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…");
            const provider = new ethers.BrowserProvider(window.ethereum);
            setStatus("æ­£åœ¨è¯·æ±‚é’±åŒ…è¿æ¥...");
            await provider.send("eth_requestAccounts", []);
            const signer = await provider.getSigner();
            const address = await signer.getAddress();

            // 2. æœ¬åœ°ç”Ÿæˆ Ed25519 å¯†é’¥å¯¹ (ä½¿ç”¨ TweetNaCl)
            setStatus("æ­£åœ¨æœ¬åœ°ç”Ÿæˆå®‰å…¨å¯†é’¥...");
            // ç”Ÿæˆéšæœºå¯†é’¥å¯¹
            const keyPair = nacl.sign.keyPair(); 
            const privKeyHex = toHex(keyPair.secretKey).slice(0, 64); // å–å‰32å­—èŠ‚ä½œä¸ºç§é’¥ç§å­(Hexé•¿åº¦64)
            const pubKeyBytes = keyPair.publicKey;
            const requestId = toBase58(pubKeyBytes); // è½¬æ¢ä¸º StandX éœ€è¦çš„ Base58 æ ¼å¼

            console.log("Generated Local PubKey (RequestId):", requestId);

            // 3. å‘æœåŠ¡å™¨æ³¨å†Œå…¬é’¥ (Pre-Sign)
            setStatus("æ­£åœ¨è¯·æ±‚æœåŠ¡å™¨éªŒè¯æŒ‘æˆ˜...");
            const prepResp = await fetch(`${API_URL}/prepare-signin?chain=bsc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    address: address, 
                    requestId: requestId // å‘é€å…¬é’¥
                })
            });
            const prepData = await prepResp.json();
            
            if (!prepData.success || !prepData.signedData) {
                throw new Error("æœåŠ¡å™¨æ‹’ç»äº†è¯·æ±‚: " + (prepData.message || "æœªçŸ¥é”™è¯¯"));
            }

            // 4. è§£ææœåŠ¡å™¨æŒ‘æˆ˜å¹¶ç­¾å
            // æœåŠ¡å™¨è¿”å›äº†ä¸€ä¸ª JWT æ ¼å¼çš„ signedDataï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶ä¸­çš„ message å­—æ®µç­¾å
            // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šServer ç»™ä½ ä¸€æ®µè¯ï¼Œä½ ç­¾åï¼Œè¯æ˜ä½ æ‹¥æœ‰è¿™ä¸ªé’±åŒ…åœ°å€
            const payloadPart = prepData.signedData.split('.')[1];
            const payload = JSON.parse(atob(payloadPart));
            const messageToSign = payload.message;

            setStatus("è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ç­¾å...");
            const signature = await signer.signMessage(messageToSign);

            // 5. æäº¤ç­¾åæ¢å– Token
            setStatus("æ­£åœ¨æ¢å–è®¿é—®ä»¤ç‰Œ...");
            const loginResp = await fetch(`${API_URL}/login?chain=bsc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    signature: signature,
                    signedData: prepData.signedData,
                    expiresSeconds: 604800 // è¯·æ±‚ 7 å¤©æœ‰æ•ˆæœŸ
                })
            });
            
            const loginData = await loginResp.json();

            if (loginData.token) {
                // æˆåŠŸï¼æ˜¾ç¤ºç»“æœ
                const expiryTime = Math.floor(Date.now() / 1000) + 604800;
                
                document.getElementById('out-priv').innerText = privKeyHex;
                document.getElementById('out-token').innerText = loginData.token;
                document.getElementById('out-expiry').innerText = expiryTime;
                
                document.getElementById('results').style.display = 'block';
                setStatus("âœ… å‡­è¯ç”ŸæˆæˆåŠŸï¼è¯·å¦¥å–„ä¿å­˜ä¸‹æ–¹ä¿¡æ¯", "success");
                btn.innerText = "ç”Ÿæˆå®Œæˆ";
            } else {
                throw new Error("ç™»å½•å¤±è´¥ï¼Œæœªæ”¶åˆ° Token");
            }

        } catch (err) {
            console.error(err);
            setStatus("âŒ é”™è¯¯: " + err.message, "error");
            btn.disabled = false;
        }
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => alert("å·²å¤åˆ¶"));
    }

    function copyAll() {
        const p = document.getElementById('out-priv').innerText;
        const t = document.getElementById('out-token').innerText;
        const e = document.getElementById('out-expiry').innerText;
        const str = `STANDX_REQUEST_PRIVATE_KEY=${p}\nSTANDX_TOKEN=${t}\nSTANDX_TOKEN_EXPIRY=${e}`;
        navigator.clipboard.writeText(str).then(() => alert("å·²å¤åˆ¶æ‰€æœ‰é…ç½®ï¼Œå¯ç›´æ¥ç²˜è´´åˆ° .env æ–‡ä»¶"));
    }
</script>

</body>
</html>
