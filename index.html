<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StandX 本地凭证提取工具 (安全版)</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@noble/curves@1.4.0/dist/umd/ed25519.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@scure/base@1.1.7/dist/index.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #0d1117; color: #c9d1d9; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: #161b22; padding: 30px; border-radius: 12px; border: 1px solid #30363d; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        h1 { color: #58a6ff; text-align: center; margin-bottom: 10px; }
        .desc { text-align: center; color: #8b949e; margin-bottom: 30px; font-size: 0.9em; }
        .step { margin-bottom: 20px; padding: 15px; background: #0d1117; border-radius: 8px; border-left: 4px solid #238636; }
        button { background-color: #238636; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; transition: background 0.2s; }
        button:hover { background-color: #2ea043; }
        button:disabled { background-color: #213322; color: #8b949e; cursor: not-allowed; }
        .result-area { margin-top: 30px; display: none; }
        .field { margin-bottom: 20px; }
        .label { display: block; color: #8b949e; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        .value-container { position: relative; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; word-break: break-all; font-family: monospace; font-size: 14px; }
        .copy-btn { position: absolute; right: 10px; top: 10px; background: #30363d; font-size: 12px; padding: 4px 8px; width: auto; }
        .warning { background: rgba(210, 153, 34, 0.1); border: 1px solid #d29922; color: #d29922; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px; }
        #status { text-align: center; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>StandX 凭证提取</h1>
        <p class="desc">本地生成，直接请求官方 API，不经过任何第三方服务器</p>

        <div class="step">
            <p>第一步：连接钱包并生成代理密钥</p>
            <button id="btn-start">开始提取 (连接 MetaMask)</button>
            <div id="status"></div>
        </div>

        <div id="result-area" class="result-area">
            <div class="field">
                <span class="label">代理钱包私钥 / AGENT WALLET PRIVATE KEY</span>
                <div class="label" style="text-transform: none;">STANDX_REQUEST_PRIVATE_KEY</div>
                <div class="value-container">
                    <span id="res-privkey"></span>
                </div>
            </div>

            <div class="field">
                <span class="label">访问令牌 / ACCESS TOKEN (JWT)</span>
                <div class="label" style="text-transform: none;">STANDX_TOKEN</div>
                <div class="value-container">
                    <span id="res-token"></span>
                </div>
            </div>

            <div class="warning">
                <strong>安全提示：</strong> 这些凭证允许完全访问您的 StandX 账户交易权限。请仅在受信任的环境中使用，切勿分享给他人。
            </div>
        </div>
    </div>

    <script>
        const btnStart = document.getElementById('btn-start');
        const status = document.getElementById('status');
        const resultArea = document.getElementById('result-area');
        
        const API_BASE = "https://api.standx.com/v1/offchain";

        btnStart.addEventListener('click', async () => {
            try {
                if (!window.ethereum) {
                    alert('请安装 MetaMask 钱包！');
                    return;
                }

                btnStart.disabled = true;
                status.innerText = "正在初始化...";
                status.style.color = "#58a6ff";

                // 1. 生成 Ed25519 密钥对
                const privKeyBytes = nobleEd25519.utils.randomSecretKey();
                const pubKeyBytes = await nobleEd25519.getPublicKey(privKeyBytes);
                const privKeyHex = Array.from(privKeyBytes).map(b => b.toString(16).padStart(2, '0')).join('');
                const requestId = scureBase.base58.encode(pubKeyBytes);

                // 2. 获取钱包地址
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const address = await signer.getAddress();
                
                status.innerText = "正在请求签名数据...";

                // 3. 请求 prepare-signin
                const prepRes = await fetch(`${API_BASE}/prepare-signin?chain=bsc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, requestId })
                });
                const prepData = await prepRes.json();
                if (!prepData.success) throw new Error("准备登录失败: " + JSON.stringify(prepData));

                const signedData = prepData.signedData;
                // 解码 JWT 获取 message (简单处理，实际生产应验证)
                const payload = JSON.parse(atob(signedData.split('.')[1]));
                const message = payload.message;

                status.innerText = "请在钱包中完成签名...";

                // 4. 钱包签名
                const signature = await signer.signMessage(message);

                status.innerText = "正在换取访问令牌...";

                // 5. 登录获取 Token
                const loginRes = await fetch(`${API_BASE}/login?chain=bsc`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signature, signedData, expiresSeconds: 604800 })
                });
                const loginData = await loginRes.json();
                
                if (loginData.token) {
                    document.getElementById('res-privkey').innerText = privKeyHex;
                    document.getElementById('res-token').innerText = loginData.token;
                    resultArea.style.display = 'block';
                    status.innerText = "✅ 提取成功！";
                    status.style.color = "#238636";
                } else {
                    throw new Error("登录失败，未获取到 Token");
                }

            } catch (err) {
                console.error(err);
                status.innerText = "❌ 错误: " + err.message;
                status.style.color = "#f85149";
                btnStart.disabled = false;
            }
        });
    </script>
</body>
</html>
