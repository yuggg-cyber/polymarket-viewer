<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Crypto Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #0b1221; }
        .font-nums { font-variant-numeric: tabular-nums; }
        .shine { position: relative; overflow: hidden; }
        .shine::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent); transform: skewX(-25deg); animation: shine 3s infinite; }
        @keyframes shine { 100% { left: 200%; } }
    </style>
</head>
<body class="text-slate-300 min-h-screen">

    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- å¤´éƒ¨ -->
        <header class="mb-8 border-b border-slate-800 pb-6">
            <div class="flex flex-col md:flex-row justify-between md:items-end gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                        <span class="text-orange-500 text-4xl">â‚¿</span> Crypto å®æ—¶ç›˜å£
                    </h1>
                    <p class="text-slate-500 text-sm mt-2">
                        åªæ˜¾ç¤ºæˆªæ­¢æ—¥æœŸåœ¨ <span class="text-orange-400 font-mono">{{ todayStr }}</span> ä¹‹åçš„æœ‰æ•ˆé¢„æµ‹
                    </p>
                </div>
                
                <div class="flex gap-3 text-xs">
                    <div class="bg-slate-900 px-4 py-2 rounded-lg border border-slate-800">
                        <div class="text-slate-500">å·²æ‰«æ</div>
                        <div class="text-white font-mono text-lg">{{ rawCount }}</div>
                    </div>
                    <div class="bg-slate-900 px-4 py-2 rounded-lg border border-orange-500/30">
                        <div class="text-orange-500">Crypto</div>
                        <div class="text-white font-mono text-lg font-bold">{{ cryptoMarkets.length }}</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="bg-red-900/30 border border-red-500/50 p-4 rounded text-center text-red-200 mb-6">
            {{ error }} <button @click="fetchMarkets" class="underline ml-2">é‡è¯•</button>
        </div>

        <!-- åˆ—è¡¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
            <div v-for="market in cryptoMarkets" :key="market.condition_id" 
                 class="bg-[#131b2e] border border-slate-800 rounded-xl p-5 hover:border-orange-500/40 transition-all duration-300 flex flex-col group relative overflow-hidden shadow-lg">
                
                <!-- é¡¶éƒ¨å…ƒæ•°æ® -->
                <div class="flex justify-between items-start mb-3 text-[10px] font-mono z-10">
                    <span class="bg-slate-800 text-orange-400 px-2 py-1 rounded border border-slate-700">
                        {{ detectCategory(market.question) }}
                    </span>
                    <span class="text-slate-500 flex items-center gap-1">
                        ğŸ•’ æˆªæ­¢: {{ formatDate(market.end_date_iso) }}
                    </span>
                </div>

                <!-- æ ‡é¢˜ -->
                <h3 class="font-medium text-slate-100 text-[15px] leading-relaxed mb-4 z-10 line-clamp-3 group-hover:text-orange-300 transition-colors">
                    <a :href="'https://polymarket.com/event/' + market.market_slug" target="_blank" class="block h-full">
                        {{ market.question }}
                    </a>
                </h3>

                <!-- ä»·æ ¼æ¡ -->
                <div class="mt-auto space-y-3 z-10">
                    <div v-for="(token, idx) in (market.tokens || []).slice(0, 2)" :key="idx" 
                         class="relative">
                        <!-- è¿›åº¦æ¡èƒŒæ™¯ -->
                        <div class="absolute inset-0 bg-slate-800 rounded overflow-hidden h-8">
                            <div class="h-full bg-slate-700/50" :style="{width: (token.price * 100) + '%'}"></div>
                        </div>
                        
                        <!-- ä»·æ ¼æ–‡å­— -->
                        <div class="relative flex justify-between items-center h-8 px-3 text-xs">
                            <span class="text-slate-300 font-medium truncate w-2/3">{{ token.outcome }}</span>
                            <span class="font-mono font-bold text-white">
                                {{ (token.price * 100).toFixed(0) }}<span class="text-[9px] text-slate-400">%</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨äº¤äº’æç¤º -->
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-purple-500 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
            </div>
        </div>

        <!-- åŠ è½½æ›´å¤š -->
        <div class="py-12 text-center">
            <button v-if="nextCursor" @click="loadMore" :disabled="loading"
                    class="px-8 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-full font-medium transition-colors border border-slate-700 disabled:opacity-50 shine">
                {{ loading ? 'æ­£åœ¨æœå¯»å…¨ç½‘æ•°æ®...' : 'åŠ è½½æ›´å¤š (Load More)' }}
            </button>
            <p v-else-if="!loading && cryptoMarkets.length === 0" class="text-slate-500">
                æš‚æ— ç¬¦åˆæ¡ä»¶çš„åŠ å¯†è´§å¸ç›˜å£
            </p>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // ğŸ‘‡ ä½ çš„ Worker åœ°å€ (ä¿æŒä¸å˜)
                const WORKER_URL = 'https://gentle-wave-3a18.9241858.workers.dev'; 

                const markets = ref([]);
                const nextCursor = ref(null);
                const loading = ref(false);
                const error = ref(null);
                const rawCount = ref(0);
                const todayStr = new Date().toLocaleDateString();

                // ğŸ” åŠ å¯†è´§å¸å…³é”®è¯åº“ (æ‰©å±•ç‰ˆ)
                const CRYPTO_KEYWORDS = [
                    'Bitcoin', 'BTC', 'Ethereum', 'ETH', 'Solana', 'SOL', 
                    'Crypto', 'Token', 'Airdrop', 'NFT', 'Price', 'Market Cap', 
                    'USDC', 'USDT', 'XRP', 'Doge', 'ETF', 'Binance', 'Coinbase',
                    'Above', 'Below', 'Hit', 'Reach' // è¿™äº›è¯å¸¸é…åˆå¸ä»·å‡ºç°
                ];

                // âš¡ è¿‡æ»¤é€»è¾‘ï¼šåªæ˜¾ç¤º Crypto ç›¸å…³
                const cryptoMarkets = computed(() => {
                    return markets.value.filter(market => {
                        const q = market.question.toLowerCase();
                        
                        // 1. å¿…é¡»åŒ…å«å…³é”®è¯
                        const hasKeyword = CRYPTO_KEYWORDS.some(k => q.includes(k.toLowerCase()));
                        if (!hasKeyword) return false;

                        // 2. å¿…é¡»æœ‰ä»·æ ¼æ•°æ®
                        if (!market.tokens || market.tokens.length < 2) return false;

                        return true;
                    });
                });

                const detectCategory = (q) => {
                    q = q.toLowerCase();
                    if (q.includes('btc') || q.includes('bitcoin')) return 'BTC';
                    if (q.includes('eth')) return 'ETH';
                    if (q.includes('sol')) return 'SOL';
                    if (q.includes('nft')) return 'NFT';
                    return 'CRYPTO';
                };

                const formatDate = (isoStr) => {
                    if (!isoStr) return 'Unknown';
                    const date = new Date(isoStr);
                    return date.toLocaleDateString() // åªæ˜¾ç¤ºæ—¥æœŸï¼Œç®€æ´ä¸€ç‚¹
                };

                const fetchMarkets = async (isLoadMore = false) => {
                    if (loading.value) return;
                    loading.value = true;
                    error.value = null;

                    try {
                        let url = WORKER_URL;
                        // åŠ ä¸ªéšæœºæ•°é˜²æ­¢æµè§ˆå™¨ç¼“å­˜è€æ•°æ®
                        const cacheBuster = `&_t=${new Date().getTime()}`;
                        
                        if (isLoadMore && nextCursor.value) {
                            url += `?cursor=${nextCursor.value}${cacheBuster}`;
                        } else {
                            url += `?start=true${cacheBuster}`;
                        }

                        const response = await axios.get(url);
                        let result = response.data;
                        if (typeof result === 'string') {
                            try { result = JSON.parse(result); } catch(e) {}
                        }

                        const newMarkets = result.data || [];
                        const cursor = result.next_cursor || null;

                        // ç®€å•çš„å»é‡é€»è¾‘ (é˜²æ­¢ç¿»é¡µå‡ºç°é‡å¤)
                        const existingIds = new Set(markets.value.map(m => m.condition_id));
                        const uniqueNewMarkets = newMarkets.filter(m => !existingIds.has(m.condition_id));

                        if (isLoadMore) {
                            markets.value = [...markets.value, ...uniqueNewMarkets];
                        } else {
                            markets.value = uniqueNewMarkets;
                        }
                        
                        rawCount.value = markets.value.length;
                        nextCursor.value = cursor;

                    } catch (err) {
                        console.error(err);
                        error.value = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚";
                    } finally {
                        loading.value = false;
                    }
                };

                const loadMore = () => fetchMarkets(true);

                onMounted(() => fetchMarkets());

                return {
                    markets, cryptoMarkets, rawCount, loading, error, nextCursor,
                    loadMore, detectCategory, formatDate, todayStr
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
