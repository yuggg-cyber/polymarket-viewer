<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket é¢„æµ‹ç›˜æµè§ˆå™¨ (Demo)</title>
    <!-- å¼•å…¥ Tailwind CSS ç”¨äºæ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Axios ç”¨äºå‘é€è¯·æ±‚ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">

    <div id="app" class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Polymarket å®æ—¶çœ‹æ¿
                </h1>
                <p class="text-slate-400 text-sm mt-1">çº¯å‰ç«¯è°ƒç”¨ Gamma API | æ‰˜ç®¡äº GitHub Pages</p>
            </div>
            
            <!-- ç®€å•çš„çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div v-if="loading" class="text-blue-400 animate-pulse flex items-center">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                åŠ è½½æ•°æ®ä¸­...
            </div>
        </header>

        <!-- é”™è¯¯æç¤º -->
        <div v-if="error" class="bg-red-900/50 border border-red-500 text-red-200 p-4 rounded-lg mb-6">
            {{ error }}
        </div>

        <!-- å¸‚åœºåˆ—è¡¨ç½‘æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div v-for="market in markets" :key="market.id" 
                 class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden hover:border-blue-500 transition-all shadow-lg hover:shadow-blue-500/10 flex flex-col">
                
                <!-- å›¾ç‰‡ä¸æ ‡é¢˜åŒºåŸŸ -->
                <div class="p-4 flex-grow">
                    <div class="flex items-start gap-3 mb-3">
                        <img :src="market.image || 'https://polymarket.com/images/fallback.png'" 
                             class="w-10 h-10 rounded-full bg-slate-700 object-cover shrink-0" 
                             @error="handleImageError">
                        <h3 class="font-semibold text-sm md:text-base leading-snug line-clamp-2" :title="market.question">
                            {{ market.question }}
                        </h3>
                    </div>
                </div>

                <!-- æ•°æ®åŒºåŸŸ -->
                <div class="bg-slate-800/50 border-t border-slate-700 p-4">
                    <!-- æ¦‚ç‡/ä»·æ ¼å±•ç¤º -->
                    <div class="space-y-2 mb-4">
                        <div v-for="(outcome, index) in JSON.parse(market.outcomeNames)" :key="index" class="flex justify-between items-center text-sm">
                            <span class="text-slate-400 truncate pr-2">{{ outcome }}</span>
                            <span class="font-mono font-bold" 
                                  :class="getProbColor(JSON.parse(market.outcomePrices)[index])">
                                {{ (parseFloat(JSON.parse(market.outcomePrices)[index]) * 100).toFixed(1) }}%
                            </span>
                        </div>
                    </div>

                    <!-- åº•éƒ¨å…ƒæ•°æ® -->
                    <div class="flex justify-between items-center text-xs text-slate-500 pt-2 border-t border-slate-700/50">
                        <span>ğŸ”¥ 24h Vol: ${{ formatMoney(market.volume24h) }}</span>
                        <a :href="'https://polymarket.com/event/' + market.slug" 
                           target="_blank" 
                           class="text-blue-400 hover:text-blue-300 hover:underline">
                            å»å®˜ç½‘äº¤æ˜“ &rarr;
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div class="text-center mt-10 mb-10" v-if="markets.length > 0">
            <button @click="loadMore" 
                    :disabled="loading"
                    class="px-8 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-full font-medium transition-colors shadow-lg shadow-blue-600/20">
                {{ loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š' }}
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const markets = ref([]);
                const loading = ref(false);
                const error = ref(null);
                const offset = ref(0);
                const limit = 12; // æ¯æ¬¡åŠ è½½çš„æ•°é‡

                // GraphQL æŸ¥è¯¢è¯­å¥
                // æˆ‘ä»¬æŒ‰ 24å°æ—¶äº¤æ˜“é‡å€’åºï¼Œåªæ˜¾ç¤ºæ´»è·ƒçš„ã€æœªå…³é—­çš„ç›˜å£
                const QUERY = `
                    query GetMarkets($limit: Int, $offset: Int) {
                        markets(
                            limit: $limit, 
                            offset: $offset, 
                            where: { closed: false, active: true, volume24h_gt: 1000 }, 
                            order: volume24h_DESC
                        ) {
                            id
                            question
                            slug
                            outcomePrices
                            outcomeNames
                            volume24h
                            image
                        }
                    }
                `;

                const fetchMarkets = async (isLoadMore = false) => {
                    if (loading.value) return;
                    loading.value = true;
                    error.value = null;

                    try {
                        // Polymarket Gamma API ç«¯ç‚¹
                        const endpoint = 'https://corsproxy.io/?' + encodeURIComponent('https://gamma-api.polymarket.com/query');
                        
                        const response = await axios.post(endpoint, {
                            query: QUERY,
                            variables: {
                                limit: limit,
                                offset: offset.value
                            }
                        });

                        if (response.data.errors) {
                            throw new Error(response.data.errors[0].message);
                        }

                        const newMarkets = response.data.data.markets;
                        
                        if (isLoadMore) {
                            markets.value = [...markets.value, ...newMarkets];
                        } else {
                            markets.value = newMarkets;
                        }
                        
                        offset.value += limit;

                    } catch (err) {
                        console.error(err);
                        error.value = "åŠ è½½æ•°æ®å¤±è´¥ã€‚å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ– API é™åˆ¶ï¼Œè¯·ç¨ååˆ·æ–°é‡è¯•ã€‚";
                    } finally {
                        loading.value = false;
                    }
                };

                // æ ¼å¼åŒ–é‡‘é¢ (e.g. 1,234,567)
                const formatMoney = (value) => {
                    if (!value) return '0';
                    return parseInt(value).toLocaleString('en-US');
                };

                // ç®€å•çš„æ¦‚ç‡é¢œè‰²åŒºåˆ†
                const getProbColor = (prob) => {
                    const p = parseFloat(prob);
                    if (p > 0.7) return 'text-green-400';
                    if (p < 0.3) return 'text-red-400';
                    return 'text-blue-300';
                };

                // å¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥
                const handleImageError = (e) => {
                    e.target.src = "https://polymarket.com/images/fallback.png";
                };

                const loadMore = () => {
                    fetchMarkets(true);
                };

                onMounted(() => {
                    fetchMarkets();
                });

                return {
                    markets,
                    loading,
                    error,
                    loadMore,
                    formatMoney,
                    getProbColor,
                    handleImageError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
