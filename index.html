<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StandX æˆæƒå·¥å…· v2.0 (å¤šé’±åŒ…ç‰ˆ)</title>
    <!-- å¼•å…¥ Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <!-- å¼•å…¥ TweetNaCl -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
    
    <style>
        :root { --bg: #0f111a; --card: #1e2330; --primary: #3b82f6; --text: #e2e8f0; --muted: #94a3b8; --border: #2d3748; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; padding-top: 40px; margin: 0; }
        .container { background-color: var(--card); width: 100%; max-width: 600px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid var(--border); }
        h2 { text-align: center; margin-top: 0; color: #fff; margin-bottom: 25px; }
        
        /* çŠ¶æ€æ  & åœ°å€æ˜¾ç¤º */
        .status-box { background: #13161c; border: 1px solid #334155; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 13px; color: var(--muted); margin-bottom: 20px; text-align: center; }
        .address-box { display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--primary); color: #60a5fa; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; font-family: monospace; font-size: 15px; }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        /* é’ˆå¯¹ä¸åŒé’±åŒ…çš„æŒ‰é’®æ ·å¼ */
        .btn-mm { background-color: #f6851b; color: #fff; } /* MetaMask Orange */
        .btn-mm:hover { background-color: #e2761b; }
        .btn-okx { background-color: #ffffff; color: #000000; } /* OKX White */
        .btn-okx:hover { background-color: #f0f0f0; }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        /* ç»“æœåŒºåŸŸ */
        .result-group { margin-top: 25px; display: none; border-top: 1px solid var(--border); padding-top: 20px; }
        .field-label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .field-box { background: #0f111a; border: 1px solid var(--border); color: #a5b4fc; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 14px; word-break: break-all; margin-bottom: 15px; }
        .copy-tag { font-size: 11px; color: var(--primary); cursor: pointer; text-decoration: underline; }
        
        .btn-copy-all { width: 100%; background-color: #10b981; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-copy-all:hover { background-color: #059669; }
    </style>
</head>
<body>

<div class="container">
    <h2>StandX æˆæƒå·¥å…· v2.0</h2>
    
    <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="status" class="status-box">è¯·é€‰æ‹©é’±åŒ…è¿›è¡Œè¿æ¥</div>
    
    <!-- æˆåŠŸè¿æ¥åæ˜¾ç¤ºåœ°å€çš„åŒºåŸŸ -->
    <div id="connected-wallet" class="address-box">
        å½“å‰åœ°å€: <span id="wallet-addr-text"></span>
    </div>

    <!-- é’±åŒ…é€‰æ‹©æŒ‰é’® -->
    <div class="btn-group">
        <button id="btn-mm" class="btn btn-mm" onclick="runProcess('metamask')">
            ğŸ¦Š è¿æ¥ MetaMask
        </button>
        <button id="btn-okx" class="btn btn-okx" onclick="runProcess('okx')">
            ğŸ”² è¿æ¥ OKX Wallet
        </button>
    </div>

    <!-- ç»“æœè¾“å‡ºåŒºåŸŸ -->
    <div id="results" class="result-group">
        <div class="field-label">
            <span>è¯·æ±‚ç§é’¥ (STANDX_REQUEST_PRIVATE_KEY)</span>
            <span class="copy-tag" onclick="copyText('out-priv')">å¤åˆ¶</span>
        </div>
        <div id="out-priv" class="field-box" style="color: #f472b6;"></div>

        <div class="field-label">
            <span>è®¿é—®ä»¤ç‰Œ (STANDX_TOKEN)</span>
            <span class="copy-tag" onclick="copyText('out-token')">å¤åˆ¶</span>
        </div>
        <div id="out-token" class="field-box"></div>

        <div class="field-label">
            <span>è¿‡æœŸæ—¶é—´ (STANDX_TOKEN_EXPIRY)</span>
        </div>
        <div id="out-expiry" class="field-box"></div>

        <button class="btn-copy-all" onclick="copyAll()">å¤åˆ¶å…¨éƒ¨é…ç½® (ç”¨äº .env)</button>
    </div>
</div>

<script>
    // é…ç½® API åœ°å€
    const API_URL = "https://api.standx.com/v1/offchain";

    // å·¥å…·å‡½æ•°ï¼šBase58 ç¼–ç 
    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function toBase58(buffer) {
        const bytes = new Uint8Array(buffer);
        let digits = [0];
        for (let i = 0; i < bytes.length; i++) {
            for (let j = 0; j < digits.length; j++) digits[j] <<= 8;
            digits[0] += bytes[i];
            let carry = 0;
            for (let j = 0; j < digits.length; j++) {
                digits[j] += carry;
                carry = (digits[j] / 58) | 0;
                digits[j] %= 58;
            }
            while (carry) {
                digits.push(carry % 58);
                carry = (carry / 58) | 0;
            }
        }
        for (let i = 0; bytes[i] === 0 && i < bytes.length - 1; i++) digits.push(0);
        return digits.reverse().map(d => ALPHABET[d]).join('');
    }

    function toHex(uint8arr) {
        return Array.from(uint8arr).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function setStatus(msg, type = 'normal') {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.style.color = type === 'error' ? '#f87171' : (type === 'success' ? '#4ade80' : '#94a3b8');
    }

    // ç¦ç”¨/å¯ç”¨æŒ‰é’®
    function toggleButtons(disabled) {
        document.getElementById('btn-mm').disabled = disabled;
        document.getElementById('btn-okx').disabled = disabled;
    }

    async function runProcess(walletType) {
        toggleButtons(true);
        try {
            // 1. é€‰æ‹©é’±åŒ… Provider
            let providerObj;
            
            if (walletType === 'okx') {
                if (typeof window.okxwallet !== 'undefined') {
                    providerObj = window.okxwallet;
                } else {
                    throw new Error("æœªæ£€æµ‹åˆ° OKX é’±åŒ…æ’ä»¶ï¼Œè¯·å…ˆå®‰è£…æˆ–è§£é”ã€‚");
                }
            } else {
                // é»˜è®¤ä¸º MetaMask / window.ethereum
                if (typeof window.ethereum !== 'undefined') {
                    // å¦‚æœè£…äº†å¤šä¸ªé’±åŒ…ï¼Œå°è¯•å¯»æ‰¾ isMetaMask æ ‡è®°
                    if (window.ethereum.providers) {
                        providerObj = window.ethereum.providers.find(p => p.isMetaMask) || window.ethereum;
                    } else {
                        providerObj = window.ethereum;
                    }
                } else {
                    throw new Error("æœªæ£€æµ‹åˆ° MetaMask é’±åŒ…æ’ä»¶ã€‚");
                }
            }

            const provider = new ethers.BrowserProvider(providerObj);
            
            setStatus(`æ­£åœ¨è¿æ¥ ${walletType === 'okx' ? 'OKX Wallet' : 'MetaMask'}...`);
            
            // è¯·æ±‚è¿æ¥
            await provider.send("eth_requestAccounts", []);
            const signer = await provider.getSigner();
            const address = await signer.getAddress();

            // 2. æ˜¾ç¤ºå½“å‰åœ°å€ (UIæ›´æ–°)
            document.getElementById('wallet-addr-text').innerText = address;
            document.getElementById('connected-wallet').style.display = 'block';
            setStatus("è¿æ¥æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆæœ¬åœ°å®‰å…¨å¯†é’¥...");

            // 3. æœ¬åœ°ç”Ÿæˆ Ed25519 å¯†é’¥
            const keyPair = nacl.sign.keyPair(); 
            const privKeyHex = toHex(keyPair.secretKey).slice(0, 64);
            const pubKeyBytes = keyPair.publicKey;
            const requestId = toBase58(pubKeyBytes);

            console.log("Generated RequestId:", requestId);

            // 4. API äº¤äº’: æ³¨å†Œå…¬é’¥
            setStatus("æ­£åœ¨è¯·æ±‚æœåŠ¡å™¨éªŒè¯...");
            const prepResp = await fetch(`${API_URL}/prepare-signin?chain=bsc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: address, requestId: requestId })
            });
            const prepData = await prepResp.json();
            
            if (!prepData.success || !prepData.signedData) {
                throw new Error("æœåŠ¡å™¨æ‹’ç»: " + (prepData.message || "æœªçŸ¥åŸå› "));
            }

            // 5. é’±åŒ…ç­¾å
            const payloadPart = prepData.signedData.split('.')[1];
            const payload = JSON.parse(atob(payloadPart));
            const messageToSign = payload.message;

            setStatus("è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤ç­¾å...");
            const signature = await signer.signMessage(messageToSign);

            // 6. æ¢å– Token
            setStatus("æ­£åœ¨è·å–æœ€ç»ˆå‡­è¯...");
            const loginResp = await fetch(`${API_URL}/login?chain=bsc`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    signature: signature,
                    signedData: prepData.signedData,
                    expiresSeconds: 604800 // 7å¤©
                })
            });
            const loginData = await loginResp.json();

            if (loginData.token) {
                // æˆåŠŸæ˜¾ç¤º
                const expiryTime = Math.floor(Date.now() / 1000) + 604800;
                
                document.getElementById('out-priv').innerText = privKeyHex;
                document.getElementById('out-token').innerText = loginData.token;
                document.getElementById('out-expiry').innerText = expiryTime;
                
                document.getElementById('results').style.display = 'block';
                setStatus("âœ… æˆæƒç”ŸæˆæˆåŠŸï¼", "success");
            } else {
                throw new Error("Token è·å–å¤±è´¥");
            }

        } catch (err) {
            console.error(err);
            setStatus("âŒ é”™è¯¯: " + err.message, "error");
        } finally {
            toggleButtons(false);
        }
    }

    function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => alert("å·²å¤åˆ¶"));
    }

    function copyAll() {
        const p = document.getElementById('out-priv').innerText;
        const t = document.getElementById('out-token').innerText;
        const e = document.getElementById('out-expiry').innerText;
        const str = `STANDX_REQUEST_PRIVATE_KEY=${p}\nSTANDX_TOKEN=${t}\nSTANDX_TOKEN_EXPIRY=${e}`;
        navigator.clipboard.writeText(str).then(() => alert("å·²å¤åˆ¶å…¨éƒ¨ï¼"));
    }
</script>

</body>
</html>
